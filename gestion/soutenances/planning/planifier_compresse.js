function Logger(a){this.loglinehtml=document.getElementById(a);if(this.loglinehtml){this.setStructure()}}Logger.prototype={setStructure:function(){this.nbetu=0;this.nbsout=0;this.message="";this.loglinehtml.innerHTML=""},setNbConv:function(a){this.nbetu=a;this.maj()},getNbConv:function(){return this.nbetu},setNbSout:function(a){this.nbsout=a;this.maj()},getNbSout:function(){return this.nbsout},setMessage:function(b,a){this.message=a?this.message+" "+b:b;this.maj()},maj:function(){this.loglinehtml.innerHTML="Etudiants : "+this.nbetu+"   Soutenances : "+this.nbsout;if(this.message!=""){this.loglinehtml.innerHTML+="<br/>"+this.message;window.setTimeout("logger.clear()",5000)}},clear:function(){this.setMessage("")},reset:function(){this.setStructure()}};Logger.prototype.constructor=Logger;logger=new Logger("logline");tree=new dhtmlXTreeObject("dhtmlxtree","100%","100%",0);tree.setSkin("dhx_skyblue");tree.enableDragAndDrop(true);tree.attachEvent("onDrag",function(){return false});tree.setImagePath("../../../classes/ihm/dhtmlxtree/imgs/csh_yellowbooks/");tree.attachEvent("onXLE",function(a,b){logger.setNbConv(a.getAllChildless().split(",").length)});var getDureeSoutenanceFiliere=function(b){for(var a=0;a<temps_soutenances.length;a++){if(temps_soutenances[a].key==b){return temps_soutenances[a].temps}}return 30};tree.setOnClickHandler(function(d){var a=tree.getUserData(d,"idsoutenance");scheduler.myDeselect(a);if(a){scheduler.mySelect(a)}var c=d.split("_")[1];var b=getDureeSoutenanceFiliere(c);scheduler.config.event_duration=b});var format_heure=scheduler.date.date_to_str("%H:%i");scheduler.config.first_hour=8;scheduler.config.last_hour=18;scheduler.config.xml_date="%Y-%m-%d %H:%i";scheduler.config.day_date="%D %d %M %Y";scheduler.config.hour_size_px=60;scheduler.xy.min_event_height=0;scheduler.xy.scale_width=40;scheduler.config.show_loading=true;dhtmlXTooltip.config.timeout_to_display=10;var getNomSalle=function(b){for(var a=0;a<salles.length;a++){if(salles[a].key==b){return salles[a].label}}return"indéfini"};scheduler.templates.tooltip_text=function(e,a,d){var c=d.idsalle?getNomSalle(d.idsalle):"indéfini";var b=d.ahuisclos==1?"oui":"non";return"<b>Etudiant :</b> "+d.details+"<br/><b>Référent :</b> "+d.parrain+"<br/><b>Examinateur :</b> "+d.examinateur+"<br/><b>Entreprise :</b> "+d.entreprise+"<br/><b>Salle :</b> "+c+"<br/><b>Huis clos :</b> "+b+"<br/><b>Début :</b> "+format_heure(e)+"<br/><b>Fin :</b> "+format_heure(a)};scheduler.do_default_dhx_cal_navline=function(){document.getElementById("identpourajax").innerHTML="<div class='dhx_cal_prev_button' style='display:none;'>&nbsp;</div>		 <div class='dhx_cal_next_button' style='display:none;'>&nbsp;</div>		 <div class='dhx_cal_today_button' style='display:none;'></div>		 <div class='dhx_cal_date' style='display:none;'></div>		 <div class='dhx_cal_tab' name='day_tab' style='right:204px; display:none;'></div>		 <div class='dhx_cal_tab' name='week_tab' style='right:140px; display:none;'></div>		 <div class='dhx_cal_tab' name='month_tab' style='right:76px; display:none;'></div>"};scheduler.attachEvent("onEventLoading",function(a){logger.setNbSout(logger.getNbSout()+1);return true});scheduler.templates.hour_scale=function(a){html="";for(var b=0;b<20;b++){a=scheduler.date.add(a,15,"minute");html+="<div style='height:20px;line-height:20px;'>"+format_heure(a)+"</div>"}return html};scheduler.xy.menu_width=0;scheduler.config.details_on_dblclick=true;scheduler.config.details_on_create=true;var contains=function(b,d){for(var c=0;c<b.length;c++){if(b[c]==d){return true}}return false};scheduler.getSallesLibres=function(){var c=this.getEvent(tree.getUserData(tree.getSelectedItemId(),"idsoutenance"));var a=this.getEvents(c.start_date,c.end_date);var d=[];var e=[];for(var b=0;b<a.length;b++){if(a[b].id!=c.id){d.push(a[b].idsalle)}}for(b=0;b<salles.length;b++){if(!contains(d,salles[b].key)){e.push(salles[b].key)}}return e};scheduler.form_blocks.my_select={render:function(d){var a=(d.height||"25")+"px";var c="<div class='dhx_cal_ltext' style='height:"+a+";'><select style='width:100%;'>";for(var b=0;b<d.options.length;b++){c+="<option value='"+d.options[b].key+"'>"+d.options[b].label+"</option>"}c+="</select></div>";return c},set_value:function(d,e,c){var f=this.getSallesLibres();var b="<select style='width:100%;'>";for(var a=0;a<f.length;a++){b+="<option value='"+f[a]+"'>"+getNomSalle(f[a])+"</option>"}if(typeof e=="undefined"){e=f[0]}if(!contains(f,e)){b+="<option value='"+e+"'>"+getNomSalle(e)+"</option>"}b+="</select>";d.innerHTML=b;d.firstChild.value=e||""},get_value:function(b,a){return b.firstChild.value},focus:function(c){var b=c.firstChild;if(b.select){b.select()}b.focus()}};scheduler.locale.labels.section_etudiant="Etudiant";scheduler.locale.labels.section_parrain="Référent";scheduler.locale.labels.section_examinateur="Examinateur";scheduler.locale.labels.section_entreprise="Entreprise";scheduler.locale.labels.section_salle="Salle";scheduler.locale.labels.section_ahuisclos="Huis clos";scheduler.config.lightbox.sections=[{name:"etudiant",height:25,type:"textarea",map_to:"details"},{name:"parrain",height:25,type:"textarea",map_to:"parrain"},{name:"examinateur",height:25,type:"textarea",map_to:"examinateur"},{name:"entreprise",height:25,type:"textarea",map_to:"entreprise"},{name:"salle",height:25,type:"my_select",map_to:"idsalle",options:salles,focus:true},{name:"ahuisclos",height:25,type:"checkbox",checked_value:1,unchecked_value:0,map_to:"ahuisclos"},{name:"time",height:72,type:"time",map_to:"auto"}];scheduler.form_blocks.textarea.set_value=function(b,c,a){b.firstChild.value=c||"";b.firstChild.disabled=true};scheduler.attachEvent("onClick",function(b,a){this.myDeselect(b);this.mySelect(b);tree.focusItem(this.getEvent(b).iditemtree);tree.selectItem(this.getEvent(b).iditemtree,true,false);return false});scheduler.templates.lightbox_header=function(c,a,b){return"Modification de la soutenance"};scheduler.mySelect=function(a){if(scheduler.idSoutenanceAvant!=null&&scheduler.idSoutenanceAvant==a){return}var c=document.getElementsByTagName("div");for(var b=0;b<c.length;b++){if(c[b].getAttribute("event_id")==a){scheduler.idSoutenanceAvant=a;scheduler.couleurAvant=c[b].getElementsByClassName("dhx_title")[0].style.backgroundColor;c[b].getElementsByClassName("dhx_title")[0].style.color=scheduler.couleurAvant;c[b].getElementsByClassName("dhx_title")[0].style.backgroundColor="#000000";return}}};scheduler.myDeselect=function(c){if(scheduler.idSoutenanceAvant!=null&&scheduler.idSoutenanceAvant!=c){var b=document.getElementsByTagName("div");for(var a=0;a<b.length;a++){if(b[a].getAttribute("event_id")==scheduler.idSoutenanceAvant){b[a].getElementsByClassName("dhx_title")[0].style.color="#000000";b[a].getElementsByClassName("dhx_title")[0].style.backgroundColor=scheduler.couleurAvant;scheduler.idSoutenanceAvant=null;return}}}};function block_readonly(a){if(!a){return true}if(scheduler.getEvent(a).readonly){logger.setMessage("Soutenance non modifiable")}return !scheduler.getEvent(a).readonly}scheduler.attachEvent("onDblClick",block_readonly);scheduler.attachEvent("onBeforeDrag",function(c,d,b){var e=this.getEvent(c).iditemtree.split("_")[1];var a=getDureeSoutenanceFiliere(e);scheduler.config.event_duration=a;if(d=="create"){logger.setMessage("Seule la création d'une soutenance par drag & drop est autorisée");return false}return block_readonly(c)});var before;scheduler.attachEvent("onBeforeLightbox",function(b){var a=scheduler.getEvent(b);before=[a.start_date,a.end_date];return true});scheduler.attachEvent("onEventChanged",function(b){if(!b){return true}var a=scheduler.getEvent(b);if(!this.isConstraintsOK(a)){if(!before){return false}a.start_date=before[0];a.end_date=before[1];a._timed=this.is_one_day_event(a)}else{this.saveSoutenance(a)}return true});scheduler.attachEvent("onBeforeEventChanged",function(a,b,c){return this.isConstraintsOK(a)});scheduler.attachEvent("onExternalDragIn",function(d,b,c){var a=this.getEvent(d);if(tree.getUserData(tree._dragged[0].id,"idsoutenance")!=0){logger.setMessage("Une soutenance existe déjà pour l'étudiant(e)");return false}a.text="";a.details=tree.getItemText(tree._dragged[0].id);a.iditemtree=tree._dragged[0].id;a.idconvention=tree.getUserData(tree._dragged[0].id,"idconvention");a.idcontrat=tree.getUserData(tree._dragged[0].id,"idcontrat");a.parrain=tree.getUserData(tree._dragged[0].id,"nom_prenom_parrain");a.idparrain=tree.getUserData(tree._dragged[0].id,"idparrain");a.color=tree.getUserData(tree._dragged[0].id,"couleur_parrain");a.textColor="#000000";a.examinateur=tree.getUserData(tree._dragged[0].id,"nom_prenom_examinateur");a.idexaminateur=tree.getUserData(tree._dragged[0].id,"idexaminateur");a.entreprise=tree.getUserData(tree._dragged[0].id,"nom_entreprise");a.idcontact=tree.getUserData(tree._dragged[0].id,"idcontact");logger.setNbSout(logger.getNbSout()+1);if(this.isConstraintsOK(a)){tree.setUserData(tree._dragged[0].id,"idsoutenance",d);tree.setItemText(tree._dragged[0].id,"<i>"+tree.getItemText(tree._dragged[0].id)+"</i>");return true}return false});scheduler.attachEvent("onEventAdded",function(b,a){this.saveSoutenance(a)});scheduler.isConstraintsOK=function(e){var b=this.getEvents(e.start_date,e.end_date);var d=false;for(var c=0;c<b.length;c++){d=b[c].id==e.id;if(!d&&b[c].idparrain==e.idparrain||b[c].idparrain==e.idexaminateur){logger.setMessage("Le référent n'est pas libre ("+e.parrain+")",true);return false}if(!d&&b[c].idexaminateur==e.idexaminateur||b[c].idexaminateur==e.idparrain){logger.setMessage("L'examinateur n'est pas libre ("+e.examinateur+")");return false}if(!d&&b[c].idcontact==e.idcontact){logger.setMessage("Le contact n'est pas libre ("+e.entreprise+")");return false}}var a=(e.end_date.getTime()-e.start_date.getTime())/1000/60;if(a!=scheduler.config.event_duration){logger.setMessage("La durée est différente de la durée normale ("+scheduler.config.event_duration+")");return false}if(b.length>salles.length&&!d){logger.setMessage("Plus de salle disponible");return false}return true};scheduler.attachEvent("onEventCancel",function(b,a){if(a){tree.setUserData(tree.getSelectedItemId(),"idsoutenance",0);tree.setItemText(tree.getSelectedItemId(),tree.getUserData(tree.getSelectedItemId(),"nom_prenom_etudiant"));logger.setNbSout(logger.getNbSout()-1);logger.setMessage("Création annulée")}});scheduler.attachEvent("onBeforeEventDelete",function(a){tree.setUserData(tree.getSelectedItemId(),"idsoutenance",0);tree.setItemText(tree.getSelectedItemId(),tree.getUserData(tree.getSelectedItemId(),"nom_prenom_etudiant"));logger.setNbSout(logger.getNbSout()-1);this.deleteSoutenance(this.getEvent(a));return true});scheduler.loadPlanning=function(annee){var dates={};var dates_request=new XMLHttpRequest();dates_request.open("GET","getDatesJSON.php?annee="+annee,true);dates_request.setRequestHeader("Content-type","application/json; charset=utf-8");dates_request.onreadystatechange=function(){if(dates_request.readyState==4&&dates_request.status==200){scheduler.do_default_dhx_cal_navline();if(dates_request.responseText!=""){dates=JSON.parse(dates_request.responseText);var dhx_cal_navline=document.getElementById("identpourajax");var taille=50;for(var i=0;i<dates.length;i++){dhx_cal_navline.innerHTML+="<div class='dhx_cal_tab' name='"+dates[i].nom+"_tab' style='left:"+taille+"px;'></div>";eval("scheduler.locale.labels."+dates[i].nom+'_tab = "'+dates[i].nom+'"');eval("scheduler.date."+dates[i].nom+'_start = function(date) { return new Date("'+dates[i].annee+'", "'+dates[i].mois+'", "'+dates[i].jour+'"); }');eval("scheduler.date.get_"+dates[i].nom+"_end = function(date) { return scheduler.date.add(date, "+dates[i].duree+', "day"); }');eval("scheduler.date.add_"+dates[i].nom+" = function(date, inc) { return null; }");eval("scheduler.templates."+dates[i].nom+"_date = scheduler.templates.week_date");eval("scheduler.templates."+dates[i].nom+"_scale_date = scheduler.templates.week_scale_date");taille+=64}scheduler.init("dhtmlxscheduler",null,dates[0].nom);scheduler.load("getDataSoutenancesXML.php?annee="+annee)}else{scheduler.init("dhtmlxscheduler",null,"week")}}};dates_request.send()};scheduler.data_attributes=function(){var d=[];var f=scheduler.templates.xml_format;for(var b in this._events){var e=this._events[b];for(var c in e){if(c.substr(0,1)!="_"&&c!="text"){d.push([c,((c=="start_date"||c=="end_date")?f:null)])}}break}return d};scheduler.toJSON=function(e){var d=[];var a=[];var b=this.data_attributes();for(var c=0;c<b.length;c++){a.push(' "'+b[c][0]+'":"'+((b[c][1]?b[c][1](e[b[c][0]]):e[b[c][0]])||"").toString().replace(/\n/g," ")+'" ')}return"{"+a.join(",")+"}"};scheduler.saveSoutenance=function(c){var b=c;var a=new XMLHttpRequest();a.open("POST","setSoutenanceJSON.php",true);a.setRequestHeader("Content-type","application/json; charset=utf-8");a.onreadystatechange=function(){if(a.readyState==4&&a.status==200){if(a.responseText!=""&&a.responseText!=0){scheduler.changeEventId(b.id,a.responseText);scheduler.idSoutenanceAvant=a.responseText;tree.setUserData(b.iditemtree,"idsoutenance",a.responseText);logger.setMessage("Soutenance sauvegardée")}else{logger.setMessage("Problème création soutenance en base");scheduler.deleteEvent(b.id)}}};a.send(this.toJSON(c))};scheduler.deleteSoutenance=function(c){var b=c;var a=new XMLHttpRequest();a.open("POST","delSoutenanceJSON.php",true);a.setRequestHeader("Content-type","application/json; charset=utf-8");a.onreadystatechange=function(){if(a.readyState==4&&a.status==200){if(a.responseText=="OK"){logger.setMessage("Soutenance supprimée")}}};a.send(this.toJSON(c))};scheduler.init("dhtmlxscheduler",null,"week");LoadData.prototype.load=function(){var a=document.getElementById("annee").value;tree.deleteChildItems(0);logger.reset();if(a!=""){tree.loadXML("getDataConvContXML.php?annee="+a);scheduler.loadPlanning(a)}else{scheduler.do_default_dhx_cal_navline(document.getElementById("identpourajax"));scheduler.clearAll();scheduler.init("dhtmlxscheduler",null,"week")}};